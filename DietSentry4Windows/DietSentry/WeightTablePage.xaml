<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:DietSentry"
             x:Class="DietSentry.WeightTablePage"
             x:Name="WeightPage">

    <ContentPage.Resources>
        <ResourceDictionary>
            <local:NumericFormatConverter x:Key="NumericFormatConverter" />
            <Style
                x:Key="TopRowButtonStyle"
                TargetType="Button">
                <Setter
                    Property="Margin"
                    Value="0,0,4,4" />
                <Setter
                    Property="WidthRequest"
                    Value="112" />
            </Style>
            <Style
                x:Key="SelectionActionButtonStyle"
                TargetType="Button">
                <Setter
                    Property="Margin"
                    Value="0,0,8,8" />
                <Setter
                    Property="WidthRequest"
                    Value="79" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid
        Padding="20"
        RowDefinitions="Auto,*,Auto"
        RowSpacing="16">
        <Grid
            Grid.Row="0"
            ColumnDefinitions="Auto,Auto,*"
            ColumnSpacing="12">
            <Label
                Grid.Column="0"
                Text="Weight Table"
                FontAttributes="Bold"
                FontSize="24"
                VerticalOptions="Start" />
            <Button
                Grid.Column="1"
                Text="Foods Table"
                HorizontalOptions="Start"
                Clicked="OnBackClicked"
                Style="{StaticResource TopRowButtonStyle}" />
        </Grid>

        <Frame
            Grid.Row="1"
            BorderColor="LightGray"
            Padding="10">
            <CollectionView
                x:Name="WeightCollectionView"
                ItemsSource="{Binding WeightEntries}"
                ItemSizingStrategy="MeasureAllItems"
                SelectionMode="Single"
                SelectionChanged="OnWeightSelectionChanged">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout
                        Orientation="Vertical"
                        ItemSpacing="4" />
                </CollectionView.ItemsLayout>
                <CollectionView.EmptyView>
                    <VerticalStackLayout Spacing="8">
                        <Label
                            Text="No weight entries yet." />
                        <Button
                            Text="Add"
                            HorizontalOptions="Start"
                            Clicked="OnAddClicked" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame
                            BorderColor="LightGray"
                            Padding="6"
                            BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}">
                            <Grid
                                ColumnDefinitions="Auto,Auto,*"
                                ColumnSpacing="6"
                                MinimumHeightRequest="24">
                                <Label
                                    Grid.Row="0"
                                    x:Name="DateLabel"
                                    Text="{Binding DateWeight}"
                                    TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                                    VerticalOptions="Start" />
                                <Label
                                    Grid.Row="0"
                                    Grid.Column="1"
                                    TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                                    HorizontalTextAlignment="End"
                                    VerticalOptions="Start"
                                    LineBreakMode="TailTruncation">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding Weight, Converter={StaticResource NumericFormatConverter}}" />
                                            <Span Text=" kg" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Label
                                    Grid.Row="0"
                                    Grid.Column="2"
                                    Text="{Binding Comments}"
                                    TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}"
                                    VerticalOptions="Start"
                                    LineBreakMode="WordWrap" />
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Frame>

        <Frame
            Grid.Row="2"
            BorderColor="LightGray"
            Padding="10"
            IsVisible="{Binding ShowSelectionPanel}">
            <VerticalStackLayout Spacing="8">
                <HorizontalStackLayout
                    HorizontalOptions="Center"
                    Spacing="8">
                    <Label
                        Text="{Binding SelectedWeightDateDisplay}"
                        FontAttributes="Bold" />
                    <Label
                        Text="{Binding SelectedWeightValueDisplay}" />
                </HorizontalStackLayout>
                <HorizontalStackLayout
                    HorizontalOptions="Center"
                    Spacing="12">
                    <Button
                        Text="Add"
                        Clicked="OnAddClicked"
                        Style="{StaticResource SelectionActionButtonStyle}" />
                    <Button
                        Text="Edit"
                        Clicked="OnEditSelectedClicked"
                        Style="{StaticResource SelectionActionButtonStyle}" />
                    <Button
                        Text="Delete"
                        Clicked="OnDeleteSelectedClicked"
                        Style="{StaticResource SelectionActionButtonStyle}" />
                </HorizontalStackLayout>
            </VerticalStackLayout>
        </Frame>

        <Grid
            Grid.Row="0"
            Grid.RowSpan="3"
            IsVisible="{Binding ShowAddPanel}">
            <BoxView Color="#80000000">
                <BoxView.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnAddBackdropTapped" />
                </BoxView.GestureRecognizers>
            </BoxView>
            <Frame
                Padding="16"
                CornerRadius="12"
                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                HorizontalOptions="Center"
                VerticalOptions="Center"
                WidthRequest="520"
                HasShadow="True">
                <Frame.Shadow>
                    <Shadow
                        Brush="#40000000"
                        Offset="0,8"
                        Radius="12"
                        Opacity="0.6" />
                </Frame.Shadow>
                <VerticalStackLayout Spacing="12">
                    <Label
                        Text="Add weight"
                        FontAttributes="Bold"
                        FontSize="18"
                        HorizontalTextAlignment="Center" />
                    <Grid
                        ColumnDefinitions="Auto,*"
                        ColumnSpacing="8">
                        <DatePicker
                            x:Name="AddDatePicker"
                            VerticalOptions="Center"
                            Grid.Column="0" />
                        <Entry
                            x:Name="AddWeightEntry"
                            Placeholder="Weight (kg)"
                            Keyboard="Numeric"
                            HorizontalOptions="FillAndExpand"
                            Grid.Column="1" />
                    </Grid>
                    <Editor
                        x:Name="AddCommentsEditor"
                        Placeholder="Comments"
                        AutoSize="TextChanges" />
                    <FlexLayout
                        Direction="Row"
                        Wrap="Wrap"
                        AlignItems="Center"
                        JustifyContent="Center">
                        <Button
                            Text="Confirm"
                            Clicked="OnAddConfirmClicked"
                            Margin="0,0,4,4" />
                        <Button
                            Text="Cancel"
                            Clicked="OnAddCancelClicked"
                            Margin="0,0,4,4" />
                    </FlexLayout>
                </VerticalStackLayout>
            </Frame>
        </Grid>

        <Grid
            Grid.Row="0"
            Grid.RowSpan="3"
            IsVisible="{Binding ShowEditPanel}">
            <BoxView Color="#80000000">
                <BoxView.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnEditBackdropTapped" />
                </BoxView.GestureRecognizers>
            </BoxView>
            <Frame
                Padding="16"
                CornerRadius="12"
                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                HorizontalOptions="Center"
                VerticalOptions="Center"
                WidthRequest="520"
                HasShadow="True">
                <Frame.Shadow>
                    <Shadow
                        Brush="#40000000"
                        Offset="0,8"
                        Radius="12"
                        Opacity="0.6" />
                </Frame.Shadow>
                <VerticalStackLayout Spacing="12">
                    <Label
                        Text="Edit weight"
                        FontAttributes="Bold"
                        FontSize="18"
                        HorizontalTextAlignment="Center" />
                    <Grid
                        ColumnDefinitions="Auto,*"
                        ColumnSpacing="8">
                        <Label
                            x:Name="EditDateLabel"
                            VerticalOptions="Center"
                            FontAttributes="Bold"
                            Grid.Column="0" />
                        <Entry
                            x:Name="EditWeightEntry"
                            Placeholder="Weight (kg)"
                            Keyboard="Numeric"
                            HorizontalOptions="FillAndExpand"
                            Grid.Column="1" />
                    </Grid>
                    <Editor
                        x:Name="EditCommentsEditor"
                        Placeholder="Comments"
                        AutoSize="TextChanges" />
                    <FlexLayout
                        Direction="Row"
                        Wrap="Wrap"
                        AlignItems="Center"
                        JustifyContent="Center">
                        <Button
                            Text="Confirm"
                            Clicked="OnEditConfirmClicked"
                            Margin="0,0,4,4" />
                        <Button
                            Text="Cancel"
                            Clicked="OnEditCancelClicked"
                            Margin="0,0,4,4" />
                    </FlexLayout>
                </VerticalStackLayout>
            </Frame>
        </Grid>

        <Grid
            Grid.Row="0"
            Grid.RowSpan="3"
            IsVisible="{Binding ShowDeletePanel}">
            <BoxView Color="#80000000">
                <BoxView.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnDeleteBackdropTapped" />
                </BoxView.GestureRecognizers>
            </BoxView>
            <Frame
                Padding="16"
                CornerRadius="12"
                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                HorizontalOptions="Center"
                VerticalOptions="Center"
                WidthRequest="420"
                HasShadow="True">
                <Frame.Shadow>
                    <Shadow
                        Brush="#40000000"
                        Offset="0,8"
                        Radius="12"
                        Opacity="0.6" />
                </Frame.Shadow>
                <VerticalStackLayout Spacing="12">
                    <Label
                        Text="Delete weight?"
                        FontAttributes="Bold"
                        FontSize="18"
                        HorizontalTextAlignment="Center" />
                    <Label
                        x:Name="DeleteDateLabel"
                        HorizontalTextAlignment="Center" />
                    <Label
                        x:Name="DeleteWeightLabel"
                        HorizontalTextAlignment="Center" />
                    <FlexLayout
                        Direction="Row"
                        Wrap="Wrap"
                        AlignItems="Center"
                        JustifyContent="Center">
                        <Button
                            Text="Confirm"
                            Clicked="OnDeleteConfirmClicked"
                            Margin="0,0,4,4" />
                        <Button
                            Text="Cancel"
                            Clicked="OnDeleteCancelClicked"
                            Margin="0,0,4,4" />
                    </FlexLayout>
                </VerticalStackLayout>
            </Frame>
        </Grid>
    </Grid>

</ContentPage>
